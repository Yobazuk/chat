{% extends "chat/base.html" %}

{% block header-text %}
    <p class="title">
        General Chatroom
    </p>
{% endblock header-text %}

{% block body %}
    <div class="column is-6 is-offset-3">
    <div class="box">
        <div id="chat-messages" style="max-height: 300px; overflow-y: scroll;">
            {% for msg in messages %}
                <b>{{ msg.username }}</b>: {{ msg.content }}<br>
            {% endfor %}
        </div>
    </div>

    <div class="field">
        <div class="control">
            <input class="input" type="text" placeholder="Message" id="chat-message-input">
        </div>
    </div>

    <div class="field">
        <div class="control">
            <a class="button is-info" id="chat-message-submit">Send</a>
        </div>
    </div>

    <small class="has-text-grey-light">Your username: {{ username }}</small>
</div>
{% endblock body %}

{% block stuff %}
    {{ username|json_script:"json-username" }}
{% endblock stuff %}

{% block script %}
    function scrollToBottom() {
        let objDiv = document.getElementById("chat-messages");
        objDiv.scrollTop = objDiv.scrollHeight;
    }

    scrollToBottom();

    const userName = JSON.parse(document.getElementById('json-username').textContent);

    const chatSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/'
        + 'chatroom'
        + '/'
    );

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log(data);

        if (data.message) {
            if (data.type == "normal") {
                document.querySelector('#chat-messages').innerHTML += ('<b>' + data.username + '</b>: ' + data.message + '<br>');
            } else if (data.type == "info") {
                document.querySelector('#chat-messages').innerHTML += ('<center><small class="has-text-grey-light">' + data.message +'</small></center>');
            }
        }

        scrollToBottom();
    };

    chatSocket.onclose = function(e) {
        console.log('The socket close unexpectedly');
    };

    const input = document.querySelector('#chat-message-input');
    input.addEventListener("keyup", function(event) {
      if (event.keyCode === 13) {
        event.preventDefault();
        document.querySelector('#chat-message-submit').click();
      }
    });

    document.querySelector('#chat-message-submit').onclick = function(e) {
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;

        chatSocket.send(JSON.stringify({
            'message': message,
            'username': userName
        }));

        messageInputDom.value = '';
    };
{% endblock script %}
